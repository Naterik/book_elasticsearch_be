generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Role {
  id          Int    @id @default(autoincrement())
  name        String @db.VarChar(20)
  description String @db.VarChar(255)

  users User[]

  @@map("roles")
}

model Genre {
  id          Int    @id @default(autoincrement())
  name        String @unique @db.VarChar(255)
  description String @db.Text

  books BooksOnGenres[]

  @@map("genres")
}

model BooksOnGenres {
  books      Book     @relation(fields: [bookId], references: [id])
  bookId     Int
  genres     Genre    @relation(fields: [genreId], references: [id])
  genreId    Int
  assignedAt DateTime @default(now())

  @@id([bookId, genreId])
}

model Author {
  id   Int     @id @default(autoincrement())
  name String  @unique @db.VarChar(255)
  bio  String? @db.Text

  books Book[]

  @@map("authors")
}

model Publisher {
  id          Int    @id @default(autoincrement())
  name        String @unique @db.VarChar(255)
  description String @db.Text

  books Book[]

  @@map("publishers")
}

model Notification {
  id        Int      @id @default(autoincrement())
  sentAt    DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  type      String   @db.VarChar(255) // LOAN, RESERVATION, FINE, PAYMENT, SYSTEM
  title     String   @default("Notification") @db.VarChar(255)
  content   String   @db.Text
  isRead    Boolean  @default(false)
  priority  String   @default("NORMAL") @db.VarChar(50) // HIGH, NORMAL, LOW

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int

  @@index([userId, isRead])
  @@index([sentAt])
  @@map("notifications")
}

model User {
  id              Int       @id @default(autoincrement())
  username        String    @unique @db.VarChar(255)
  password        String    @db.VarChar(255)
  fullName        String?   @db.VarChar(255)
  address         String?   @db.VarChar(255)
  phone           String?   @db.VarChar(255)
  avatar          String?   @db.VarChar(255)
  type            String    @default("SYSTEM")
  cardNumber      String?   @unique @db.VarChar(50)
  membershipStart DateTime?
  membershipEnd   DateTime?
  status          String    @default("PENDING_CARD") // ACTIVE, PENDING_CARD, INACTIVE, SUSPENDED
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now()) @updatedAt

  roleId Int
  role   Role @relation(fields: [roleId], references: [id])

  loans         Loan[]
  reservations  Reservation[]
  notifications Notification[]
  fines         Fine[]
  payments      Payment[]
  historysearch Historysearch[]

  @@map("users")
}

model Historysearch {
  id        Int      @id @default(autoincrement())
  userId    Int
  term      String
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, term])
  @@fulltext([term])
  @@map("history_searches")
}

model Bookcopy {
  id             Int    @id @default(autoincrement())
  year_published Int    @db.Year
  copyNumber     String @db.VarChar(25)
  status         String @default("AVAILABLE") @db.VarChar(25) // AVAILABLE, ON_LOAN, ON_HOLD, LOST

  heldByUserId   Int?
  holdExpiryDate DateTime?

  books  Book @relation(fields: [bookId], references: [id])
  bookId Int

  loans Loan[]

  @@map("book_copy")
}

model Loan {
  id           Int       @id @default(autoincrement())
  loanDate     DateTime  @default(now())
  dueDate      DateTime?
  returnDate   DateTime?
  renewalCount Int       @default(0)
  status       String    @db.VarChar(255) // ON_LOAN, RETURNED, OVERDUE, LOST
  bookCopy     Bookcopy  @relation(fields: [bookcopyId], references: [id])
  bookcopyId   Int

  user   User @relation(fields: [userId], references: [id])
  userId Int

  fine Fine?

  @@map("loans")
}

model Reservation {
  id          Int       @id @default(autoincrement())
  requestDate DateTime?
  status      String    @db.VarChar(255) // PENDING, NOTIFIED, COMPLETED, CANCELLED

  book   Book @relation(fields: [bookId], references: [id])
  bookId Int

  user   User @relation(fields: [userId], references: [id])
  userId Int

  @@map("reservations")
}

model Fine {
  id     Int     @id @default(autoincrement())
  amount Int
  reason String  @db.VarChar(255) // OVERDUE, LOST, DAMAGED
  isPaid Boolean @default(false)

  loan   Loan @relation(fields: [loanId], references: [id])
  loanId Int  @unique

  user   User @relation(fields: [userId], references: [id])
  userId Int

  payment Payment?

  @@map("fines")
}

model Payment {
  id          Int      @id @default(autoincrement())
  amount      Int
  paymentDate DateTime @default(now())
  type        String   @db.VarChar(50) // MEMBERSHIP_FEE, FINE_PAYMENT
  paymentRef  String?
  status      String   @default("UNPAID") @db.VarChar(20)
  user        User     @relation(fields: [userId], references: [id])
  userId      Int

  fine   Fine? @relation(fields: [fineId], references: [id])
  fineId Int?  @unique

  @@map("payments")
}

model Book {
  id          Int       @id @default(autoincrement())
  isbn        String    @unique(map: "Book_isbn_key")
  title       String    @db.VarChar(255)
  shortDesc   String    @db.VarChar(255)
  detailDesc  String    @db.MediumText
  price       Int
  quantity    Int       @default(1)
  publishDate DateTime? @db.Date
  image       String?   @db.MediumText
  language    String?   @db.VarChar(20)
  pages       Int
  borrowed    Int       @default(0)

  authors  Author @relation(fields: [authorId], references: [id])
  authorId Int

  publishers  Publisher @relation(fields: [publisherId], references: [id])
  publisherId Int

  bookCopies   Bookcopy[]
  genres       BooksOnGenres[]
  reservations Reservation[]
  digitalBook  DigitalBook?

  @@map("books")
}

enum PreviewStatus {
  NO_VIEW
  FULL
  RESTRICTED 
}

model DigitalBook {
  @@map("digital_books")
  id          Int           @id @default(autoincrement())
  status      PreviewStatus @default(NO_VIEW)
  previewUrl  String?       @db.Text 
  updatedAt   DateTime      @updatedAt 
  
  bookId      Int           @unique
  book        Book          @relation(fields: [bookId], references: [id])
}
